<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>WebSocket éº¦å…‹é£Žæµ‹è¯• (16â€¯kHz)</title>
</head>

<body>
    <button id="recordBtn">å¼€å§‹å½•éŸ³ï¼ˆéº¦å…‹é£Žï¼‰</button>

    <script>
        // æŒ‡å®š WebSocket æœåŠ¡ç«¯åœ°å€
        const WS_URL = "ws://115.190.106.113:5001/vad_asr";
        console.log('WS_URL =', WS_URL);

        let ws, recording = false, audioCtx, sourceNode, processor, stream;
        const CHUNK = 512;       // 16â€¯kHz æ—¶ â‰ˆ32â€¯ms

        document.getElementById('recordBtn').onclick = async () => {
            if (!recording) {
                // å»ºç«‹ WebSocket è¿žæŽ¥
                ws = new WebSocket(WS_URL);
                ws.binaryType = 'arraybuffer';
                ws.onopen = () => console.log('âœ… WS æ¡æ‰‹æˆåŠŸ');
                ws.onerror = e => console.error('âŒ WS é”™è¯¯', e);
                ws.onclose = () => console.log('âš ï¸ WS å·²å…³é—­');
                ws.onmessage = m => console.log('ðŸ“© ASR:', m.data);

                // ä½¿ç”¨éº¦å…‹é£Žè¾“å…¥ï¼ˆè¯·æ±‚ 16â€¯kHz / 16-bit / å•å£°é“ï¼‰
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 16000,
                        sampleSize: 16,
                        channelCount: 1
                    },
                    video: false
                });

                // åˆ›å»º 16â€¯kHz AudioContext
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                console.log('ðŸŽ›ï¸ AudioContext sampleRate =', audioCtx.sampleRate);

                sourceNode = audioCtx.createMediaStreamSource(stream);
                processor = audioCtx.createScriptProcessor(CHUNK, 1, 1);

                processor.onaudioprocess = e => {
                    const f = e.inputBuffer.getChannelData(0);
                    const out = new Int16Array(f.length);
                    for (let i = 0; i < f.length; i++) {
                        let s = Math.max(-1, Math.min(1, f[i]));
                        out[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(out.buffer);
                    }
                };

                sourceNode.connect(processor);
                processor.connect(audioCtx.destination);

                recording = true;
                recordBtn.textContent = 'åœæ­¢å½•éŸ³ï¼ˆéº¦å…‹é£Žï¼‰';
            } else {
                // åœæ­¢å½•éŸ³å¹¶å…³é—­è¿žæŽ¥
                processor.disconnect();
                sourceNode.disconnect();
                stream.getTracks().forEach(t => t.stop());
                ws.close();
                recording = false;
                recordBtn.textContent = 'å¼€å§‹å½•éŸ³ï¼ˆéº¦å…‹é£Žï¼‰';
            }
        };
    </script>
</body>

</html>