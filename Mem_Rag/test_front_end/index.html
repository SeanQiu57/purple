<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ä¹é‡Memory è°ƒè¯•</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 1rem;
        }

        section {
            margin-bottom: 2rem;
        }

        textarea,
        input[type="text"] {
            width: 100%;
            box-sizing: border-box;
        }

        pre {
            background: #f5f5f5;
            padding: .5rem;
            overflow-x: auto;
        }

        button {
            margin-top: .5rem;
            padding: .5rem 1rem;
        }

        .error {
            color: red;
        }
    </style>
</head>

<body>
    <h1>ä¹é‡Memory è°ƒè¯•ç•Œé¢</h1>

    <!-- ç”¨æˆ· ID è¾“å…¥ -->
    <section>
        <h2>ğŸ‘¤ ç”¨æˆ· ID</h2>
        <label for="user-id">è¯·è¾“å…¥ç”¨æˆ·å”¯ä¸€ IDï¼š</label><br>
        <input type="text" id="user-id" placeholder="ä¾‹å¦‚ï¼šuser1234"><br>
    </section>

    <!-- æŸ¥è¯¢è®°å¿† -->
    <section>
        <h2>ğŸ” æŸ¥è¯¢è®°å¿†</h2>
        <label>è¾“å…¥æŸ¥è¯¢æ–‡æœ¬ï¼š</label><br>
        <input type="text" id="q-input" placeholder="ä¾‹å¦‚ï¼šä½ å¥½ï¼Œè®°å¿†å¦‚ä½•ï¼Ÿ"><br>
        <button id="q-btn">æŸ¥è¯¢</button>
        <pre id="q-out"></pre>
    </section>

    <!-- æ‰¹é‡å¯¼å…¥ & æ¸…ç©º -->
    <section>
        <h2>ğŸ“¥ æ‰¹é‡å¯¼å…¥ / ğŸ“¤ æ¸…ç©ºé•¿æœŸè®°å¿†</h2>
        <label>æ¯è¡Œä¸€æ®µè¦å¯¼å…¥çš„æ–‡æœ¬ï¼š</label><br>
        <textarea id="imp-texts" rows="6" placeholder="ç¬¬ä¸€æ®µæ–‡æœ¬\nç¬¬äºŒæ®µæ–‡æœ¬\nâ€¦"></textarea><br>
        <button id="imp-btn">å¯¼å…¥</button>
        <button id="del-btn" style="margin-left:1rem; background:#e74c3c; color:white;">æ¸…ç©ºé•¿æœŸè®°å¿†</button>
        <pre id="imp-out"></pre>
    </section>

    <script>
        // è·å–ç”¨æˆ· ID
        function getUserId() {
            const uid = document.getElementById("user-id").value.trim();
            if (!uid) {
                alert("è¯·å…ˆè¾“å…¥ç”¨æˆ·å”¯ä¸€ IDï¼");
                throw new Error("Missing user_id");
            }
            return uid;
        }

        // ç»Ÿä¸€å±•ç¤ºç»“æœ
        function showResult(elem, status, body, isError = false) {
            elem.textContent = `HTTP ${status}\n\n` + body;
            elem.classList.toggle("error", isError);
        }

        // æŸ¥è¯¢
        document.getElementById("q-btn").onclick = async () => {
            const out = document.getElementById("q-out"); out.textContent = "";
            let q = document.getElementById("q-input").value.trim();
            if (!q) return alert("è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹ï¼");
            let uid;
            try { uid = getUserId(); } catch { return; }
            try {
                const resp = await fetch(`/memory/query`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: uid, q })
                });
                const txt = await resp.text();
                if (!resp.ok) showResult(out, resp.status, txt, true);
                else showResult(out, resp.status, JSON.stringify(JSON.parse(txt), null, 2));
            } catch (e) { showResult(out, "-", e.toString(), true); }
        };

        // æ‰¹é‡å¯¼å…¥
        document.getElementById("imp-btn").onclick = async () => {
            const out = document.getElementById("imp-out"); out.textContent = "";
            const texts = document.getElementById("imp-texts").value.split("\n").map(s => s.trim()).filter(s => s);
            if (texts.length === 0) return alert("è¯·å…ˆè¾“å…¥è‡³å°‘ä¸€æ®µæ–‡æœ¬ï¼");
            let uid;
            try { uid = getUserId(); } catch { return; }
            try {
                const resp = await fetch(`/memory/import`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: uid, texts })
                });
                const txt = await resp.text();
                if (!resp.ok) showResult(out, resp.status, txt, true);
                else showResult(out, resp.status, JSON.stringify(JSON.parse(txt), null, 2));
            } catch (e) { showResult(out, "-", e.toString(), true); }
        };

        // æ¸…ç©º
        document.getElementById("del-btn").onclick = async () => {
            const out = document.getElementById("imp-out"); out.textContent = "";
            if (!confirm("ç¡®å®šè¦æ¸…ç©ºé•¿æœŸè®°å¿†ï¼Ÿä¸å¯æ¢å¤ï¼")) return;
            let uid;
            try { uid = getUserId(); } catch { return; }
            try {
                const resp = await fetch(`/memory/clear?user_id=${uid}`, { method: "DELETE" });
                const txt = await resp.text();
                if (!resp.ok) showResult(out, resp.status, txt, true);
                else showResult(out, resp.status, JSON.stringify(JSON.parse(txt), null, 2));
            } catch (e) { showResult(out, "-", e.toString(), true); }
        };
    </script>
</body>

</html>