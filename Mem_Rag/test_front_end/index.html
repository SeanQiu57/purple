<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ä¹é‡Memory è°ƒè¯•</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 1rem;
        }

        section {
            margin-bottom: 2rem;
        }

        textarea,
        input[type="text"] {
            width: 100%;
            box-sizing: border-box;
        }

        pre {
            background: #f5f5f5;
            padding: .5rem;
            overflow-x: auto;
        }

        button {
            margin-top: .5rem;
            padding: .5rem 1rem;
        }

        .error {
            color: red;
        }

        .mem-block {
            margin: .5rem 0;
        }

        .mem-block textarea {
            height: 4em;
        }
    </style>
</head>

<body>
    <h1>ä¹é‡Memory è°ƒè¯•ç•Œé¢</h1>

    <script>
        // 1. è¯»å–å·²ç™»å½• user_id
        const uid = localStorage.getItem('user_id');
        if (!uid) {
            alert('æœªæ£€æµ‹åˆ°ç”¨æˆ· IDï¼Œè¯·å…ˆç™»å½•');
            location.href = 'login.html';
        }
    </script>

    <!-- æ˜¾ç¤ºå½“å‰ç”¨æˆ· & é€€å‡ºç™»å½• -->
    <section>
        <h2>ğŸ‘¤ å½“å‰ç”¨æˆ·</h2>
        <div>
            ç”¨æˆ· IDï¼š<strong id="display-uid"></strong>
            <button id="logout-btn" style="margin-left:1rem; background:#e74c3c; color:#fff;">é€€å‡ºç™»å½•</button>
        </div>
    </section>

    <!-- æŸ¥è¯¢è®°å¿† -->
    <section>
        <h2>ğŸ” æŸ¥è¯¢è®°å¿†</h2>
        <label>è¾“å…¥æŸ¥è¯¢æ–‡æœ¬ï¼š</label><br>
        <input type="text" id="q-input" placeholder="ä¾‹å¦‚ï¼šä½ å¥½ï¼Œè®°å¿†å¦‚ä½•ï¼Ÿ"><br>
        <button id="q-btn">æŸ¥è¯¢</button>
        <pre id="q-out"></pre>
    </section>

    <!-- æ‰¹é‡å¯¼å…¥ & æ¸…ç©º -->
    <section>
        <h2>ğŸ“¥ æ‰¹é‡å¯¼å…¥ / ğŸ“¤ æ¸…ç©ºé•¿æœŸè®°å¿†</h2>
        <label>æ¯è¡Œä¸€æ®µè¦å¯¼å…¥çš„æ–‡æœ¬ï¼š</label><br>
        <textarea id="imp-texts" rows="6" placeholder="ç¬¬ä¸€æ®µæ–‡æœ¬\nç¬¬äºŒæ®µæ–‡æœ¬\nâ€¦"></textarea><br>
        <button id="imp-btn">å¯¼å…¥</button>
        <button id="del-btn" style="margin-left:1rem; background:#e74c3c; color:white;">æ¸…ç©ºé•¿æœŸè®°å¿†</button>
        <pre id="imp-out"></pre>
    </section>

    <!-- åŠ è½½ & ç¼–è¾‘ çŸ­æœŸ/å·¥ä½œè®°å¿† -->
    <section>
        <h2>âœï¸ åŠ è½½ & ç¼–è¾‘ çŸ­æœŸ / å·¥ä½œ è®°å¿†</h2>
        <button id="load-mem-btn">åŠ è½½è®°å¿†</button>

        <div id="short-mem-container">
            <h3>çŸ­æœŸè®°å¿†</h3>
            <div id="short-mem-list"></div>
        </div>

        <div id="working-mem-container">
            <h3>å·¥ä½œè®°å¿†</h3>
            <div id="working-mem-list"></div>
        </div>
    </section>

    <script>
        // æŠŠ uid æ˜¾ç¤ºåˆ°é¡µé¢ä¸Š
        document.getElementById('display-uid').innerText = uid;
        // é€€å‡ºç™»å½•ï¼šæ¸…é™¤å¹¶è·³å› login.html
        document.getElementById('logout-btn').onclick = () => {
            if (confirm('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ')) {
                localStorage.removeItem('user_id');
                location.href = 'login.html';
            }
        };

        // ç»Ÿä¸€å±•ç¤ºç»“æœ
        function showResult(elem, status, body, isError = false) {
            elem.textContent = `HTTP ${status}\n\n` + body;
            elem.classList.toggle("error", isError);
        }

        // æŸ¥è¯¢
        document.getElementById("q-btn").onclick = async () => {
            const out = document.getElementById("q-out");
            out.textContent = "";
            const q = document.getElementById("q-input").value.trim();
            if (!q) return alert("è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹ï¼");
            try {
                const resp = await fetch(`/memory/query`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: uid, q })
                });
                const txt = await resp.text();
                if (!resp.ok) {
                    showResult(out, resp.status, txt, true);
                } else {
                    showResult(out, resp.status, JSON.stringify(JSON.parse(txt), null, 2));
                }
            } catch (e) {
                showResult(out, "-", e.toString(), true);
            }
        };

        // æ‰¹é‡å¯¼å…¥
        document.getElementById("imp-btn").onclick = async () => {
            const out = document.getElementById("imp-out");
            out.textContent = "";
            const texts = document.getElementById("imp-texts").value
                .split("\n").map(s => s.trim()).filter(s => s);
            if (texts.length === 0) return alert("è¯·å…ˆè¾“å…¥è‡³å°‘ä¸€æ®µæ–‡æœ¬ï¼");
            try {
                const resp = await fetch(`/memory/import`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: uid, texts })
                });
                const txt = await resp.text();
                if (!resp.ok) {
                    showResult(out, resp.status, txt, true);
                } else {
                    showResult(out, resp.status, JSON.stringify(JSON.parse(txt), null, 2));
                }
            } catch (e) {
                showResult(out, "-", e.toString(), true);
            }
        };

        // æ¸…ç©º
        document.getElementById("del-btn").onclick = async () => {
            const out = document.getElementById("imp-out");
            out.textContent = "";
            if (!confirm("ç¡®å®šè¦æ¸…ç©ºé•¿æœŸè®°å¿†ï¼Ÿä¸å¯æ¢å¤ï¼")) return;
            try {
                const resp = await fetch(`/memory/clear?user_id=${encodeURIComponent(uid)}`, {
                    method: "DELETE"
                });
                const txt = await resp.text();
                if (!resp.ok) {
                    showResult(out, resp.status, txt, true);
                } else {
                    showResult(out, resp.status, JSON.stringify(JSON.parse(txt), null, 2));
                }
            } catch (e) {
                showResult(out, "-", e.toString(), true);
            }
        };

        // åŠ è½½ & ç¼–è¾‘ çŸ­æœŸ / å·¥ä½œ è®°å¿†
        document.getElementById("load-mem-btn").onclick = async () => {
            // çŸ­æœŸè®°å¿†
            try {
                const resp = await fetch(`/memory/short?user_id=${encodeURIComponent(uid)}`);
                if (!resp.ok) throw new Error(`çŸ­æœŸè®°å¿†åŠ è½½å¤±è´¥: ${resp.status}`);
                const { short } = await resp.json();
                const list = document.getElementById("short-mem-list");
                list.innerHTML = "";
                short.forEach(item => {
                    const div = document.createElement("div");
                    div.className = "mem-block";
                    div.innerHTML = `
            <textarea data-id="${item.id}">${item.content}</textarea>
            <button data-id="${item.id}" class="save-short">ä¿å­˜çŸ­æœŸè®°å¿†</button>
          `;
                    list.append(div);
                });
            } catch (e) {
                alert(e);
            }

            // å·¥ä½œè®°å¿†
            try {
                const resp2 = await fetch(`/memory/working?user_id=${encodeURIComponent(uid)}`);
                if (!resp2.ok) throw new Error(`å·¥ä½œè®°å¿†åŠ è½½å¤±è´¥: ${resp2.status}`);
                const { working } = await resp2.json();
                const wm = document.getElementById("working-mem-list");
                wm.innerHTML = "";
                if (working) {
                    const div = document.createElement("div");
                    div.className = "mem-block";
                    div.innerHTML = `
            <textarea id="working-text">${working.content}</textarea>
            <button id="save-working">ä¿å­˜å·¥ä½œè®°å¿†</button>
          `;
                    wm.append(div);
                }
            } catch (e) {
                alert(e);
            }
        };

        // ä¿å­˜çŸ­æœŸè®°å¿†
        document.body.addEventListener("click", async e => {
            if (!e.target.matches(".save-short")) return;
            const id = e.target.dataset.id;
            const textarea = document.querySelector(`textarea[data-id="${id}"]`);
            try {
                const resp = await fetch("/memory/short", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: uid,
                        id: Number(id),
                        content: textarea.value
                    })
                });
                if (!resp.ok) throw new Error(`ä¿å­˜å¤±è´¥: ${resp.status}`);
                alert("çŸ­æœŸè®°å¿†å·²ä¿å­˜");
            } catch (err) {
                alert(err);
            }
        });

        // ä¿å­˜å·¥ä½œè®°å¿†
        document.body.addEventListener("click", async e => {
            if (e.target.id !== "save-working") return;
            const content = document.getElementById("working-text").value;
            try {
                const resp = await fetch("/memory/working", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: uid, content })
                });
                if (!resp.ok) throw new Error(`ä¿å­˜å¤±è´¥: ${resp.status}`);
                alert("å·¥ä½œè®°å¿†å·²ä¿å­˜");
            } catch (err) {
                alert(err);
            }
        });
    </script>
</body>

</html>